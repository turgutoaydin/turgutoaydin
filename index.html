<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>POOL SPIN ‚Ä¢ WEB5</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<style>
:root{
  --bg:#050712;
  --bg2:#050b1e;
  --bg3:#130824;
  --glass:rgba(255,255,255,0.04);
  --border:rgba(173,216,230,0.16);
  --cyan:#00eaff;
  --green:#00ff99;
  --violet:#a15cff;
  --pink:#ff46b9;
  --orange:#ffb347;
  --danger:#ff4b6a;
}
*{box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{
  margin:0;color:#eaf6ff;
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,system-ui,sans-serif;
  background:
    radial-gradient(120% 160% at -10% -10%, #1b284b 0%, var(--bg) 55%),
    radial-gradient(80% 100% at 120% -10%, #23184b 0%, var(--bg2) 60%),
    radial-gradient(140% 180% at 50% 120%, #3a103f 0%, var(--bg3) 75%);
}

/* arka plan canvaslarƒ± */
canvas.bg,canvas.aur{
  position:fixed;inset:0;pointer-events:none;
}
canvas.bg{z-index:0;opacity:.65}
canvas.aur{z-index:1;mix-blend-mode:screen;opacity:.55;filter:saturate(1.2)}

/* ana app */
.app{
  position:relative;z-index:2;
  height:100dvh;max-width:560px;margin:0 auto;
  padding:10px 12px 12px;
  display:flex;flex-direction:column;gap:8px;
}

/* HEADER */
.header{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.back{
  width:40px;height:40px;border-radius:14px;
  border:1px solid var(--border);
  background:linear-gradient(135deg,rgba(255,255,255,.05),rgba(255,255,255,.01));
  backdrop-filter:blur(14px);
  display:grid;place-items:center;font-size:18px;
}
.brand{
  flex:1;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.06);
  background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
  backdrop-filter:blur(12px);
  display:flex;flex-direction:column;gap:2px;
}
.brand-top{
  display:flex;align-items:center;gap:8px;font-size:13px;font-weight:800;
}
.brand-dot{
  width:9px;height:9px;border-radius:50%;
  background:conic-gradient(from 0deg,var(--cyan),var(--pink),var(--green),var(--cyan));
  box-shadow:0 0 12px rgba(0,234,255,.8);
  animation:pulseDot 2s ease-in-out infinite;
}
.brand-sub{
  font-size:10px;opacity:.7;letter-spacing:.12em;text-transform:uppercase;
}
.fx-toggle{
  width:40px;height:40px;border-radius:14px;
  border:1px solid var(--border);
  background:linear-gradient(135deg,rgba(255,255,255,.05),rgba(255,255,255,.01));
  backdrop-filter:blur(14px);
  font-size:14px;display:flex;align-items:center;justify-content:center;
}
.fx-toggle.on{
  border-color:var(--cyan);
  box-shadow:0 0 14px rgba(0,234,255,.7);
}

/* STAGE */
.stage{
  flex:1;display:flex;align-items:center;justify-content:center;
  perspective:1100px;position:relative;transition:transform .3s ease-out;
}
.board-wrap{
  width:min(94vw,360px);height:min(94vw,360px);
  transform-style:preserve-3d;
  animation:float 8s ease-in-out infinite;
}
.board{
  position:relative;inset:0;height:100%;
  display:grid;grid-template-columns:repeat(6,1fr);gap:4px;padding:10px;
  border-radius:22px;
  background:
    radial-gradient(circle at 10% 0%,rgba(0,234,255,.25),transparent 48%),
    radial-gradient(circle at 90% 0%,rgba(255,70,185,.22),transparent 52%),
    linear-gradient(180deg,rgba(7,10,30,.94),rgba(5,7,22,.98));
  border:2px solid rgba(0,234,255,.22);
  box-shadow:
    0 0 50px rgba(0,234,255,.25),
    0 0 70px rgba(255,70,185,.18),
    inset 0 0 26px rgba(0,234,255,.2);
  backdrop-filter:blur(22px) saturate(1.25);
}

/* h√ºcreler */
.cell{
  position:relative;overflow:hidden;
  border-radius:14px;
  background:radial-gradient(circle at 30% 20%,rgba(255,255,255,.18),rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.08);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.16),0 10px 24px rgba(0,0,0,.55);
  backdrop-filter:blur(10px) saturate(1.1);
}
.cell::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(145deg,rgba(5,10,30,.95),rgba(5,6,18,.96));
  opacity:.58;
}

/* slot ≈üeridi */
.slot{
  position:absolute;inset:0;
  display:flex;flex-direction:column;
  transform:translateY(-1500%);
}
.pane{
  flex:0 0 100%;
  display:flex;align-items:center;justify-content:center;
  font-size:30px;line-height:1;position:relative;z-index:1;
  text-shadow:
    0 0 6px rgba(0,0,0,.7),
    0 0 10px rgba(0,234,255,.65),
    0 8px 12px rgba(0,0,0,.75);
  transform:translateZ(8px);
}
.pane.rare{
  text-shadow:
    0 0 6px rgba(0,0,0,.7),
    0 0 16px rgba(255,255,255,1),
    0 0 24px rgba(0,255,153,.9),
    0 10px 18px rgba(0,0,0,.8);
}
.roll{animation:roll 1.25s cubic-bezier(.18,.75,.25,1) forwards;}
@keyframes roll{
  from{transform:translateY(-1500%)}
  to{transform:translateY(0)}
}

/* win fx */
.cell.flash::before{
  opacity:.12;
  background:radial-gradient(circle at 50% 5%,rgba(255,255,255,.95),rgba(0,255,153,.35) 40%,rgba(0,234,255,.1) 70%);
}
.cell.flash{
  box-shadow:
    0 0 40px rgba(0,255,153,.9),
    0 0 40px rgba(0,234,255,.8),
    0 0 70px rgba(255,255,255,.4);
}
.cell.explode{animation:explode .35s ease forwards;}
@keyframes explode{
  to{
    transform:translateZ(32px) translateY(-12px) scale(.55) rotate3d(.4,.2,-.3,28deg);
    opacity:0;filter:blur(2px);
  }
}

/* rare orbit */
.cell.rare-orbit::after{
  content:'';position:absolute;inset:3px;
  border-radius:14px;border:2px solid rgba(0,234,255,.9);
  box-shadow:0 0 16px rgba(0,234,255,.9);
  animation:orbit 1.2s linear infinite;
}
@keyframes orbit{to{transform:rotate(360deg)}}

/* bottom stats */
.bottom{
  margin-top:2px;display:flex;flex-direction:column;gap:6px;
}
.bottom-row{
  display:flex;gap:10px;
}
.stat-box{
  flex:1;
  padding:8px 11px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.07);
  background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.015));
  backdrop-filter:blur(14px);
  font-size:11px;
}
.stat-label{
  opacity:.75;letter-spacing:.07em;font-size:9px;margin-bottom:2px;text-transform:uppercase;
}
.balance-val{
  display:flex;align-items:baseline;gap:4px;
  font-weight:900;font-size:13px;
  background:linear-gradient(90deg,var(--cyan),var(--green));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.balance-val span.cur{
  font-size:10px;-webkit-text-fill-color:#eaf6ff;color:#eaf6ff;
}
.lastwin-val{
  font-weight:800;font-size:13px;color:var(--orange);
  text-shadow:0 0 12px rgba(255,179,71,.6);
}

/* mini history */
.history{
  display:flex;gap:6px;font-size:9px;align-items:center;padding:0 2px;
}
.history-label{opacity:.6;letter-spacing:.08em;text-transform:uppercase;}
.dot-row{display:flex;gap:4px;}
.dot{
  width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.18);
}
.dot.win-small{background:#00ff99;box-shadow:0 0 6px rgba(0,255,153,.8);}
.dot.win-big{background:#ffd700;box-shadow:0 0 8px rgba(255,215,0,.95);}
.dot.lose{background:#ff4b6a;box-shadow:0 0 6px rgba(255,75,106,.9);}

/* controls */
.controls{
  display:flex;align-items:center;justify-content:center;
  gap:16px;padding:6px 0 0;
}
.auto-btn{
  width:38px;height:38px;border-radius:12px;
  border:1px solid var(--border);
  background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
  backdrop-filter:blur(10px);
  font-weight:900;font-size:9px;letter-spacing:.08em;
}
.auto-btn.on{
  background:rgba(0,255,153,.25);
  border-color:var(--green);
  box-shadow:0 0 16px rgba(0,255,153,.45) inset;
}

/* spin core */
.spin{
  width:118px;height:118px;border-radius:50%;border:none;position:relative;cursor:pointer;
  background:radial-gradient(circle at 30% 30%, #00eaff, #0050ff);
  box-shadow:
    0 0 60px rgba(0,234,255,.5),
    0 0 90px rgba(255,70,185,.4),
    inset 0 0 30px rgba(255,255,255,.12);
}
.spin:disabled{opacity:.55;cursor:not-allowed}
.ring{
  position:absolute;inset:-4px;border-radius:50%;
  background:conic-gradient(from 0deg,var(--cyan),var(--violet),var(--green),var(--pink),var(--cyan));
  animation:ring 4s linear infinite;filter:saturate(1.2);
}
.ring.inner{
  inset:10px;animation-duration:6s;opacity:.7;filter:blur(.2px);
}
.spin .core{
  position:absolute;inset:14px;border-radius:50%;
  background:radial-gradient(120% 120% at 30% 30%, #1ad7ff, #004bff 70%);
  display:flex;align-items:center;justify-content:center;overflow:hidden;
}
.wave{
  position:absolute;inset:-18px;border-radius:50%;border:3px solid var(--cyan);
  opacity:0;animation:wave 2s ease-out infinite;
}
.wave.d{animation-delay:.5s}
.spinlabel{
  position:absolute;bottom:-24px;width:100%;text-align:center;
  font-weight:900;letter-spacing:2px;color:var(--cyan);text-shadow:0 0 16px var(--cyan);font-size:12px;
}

/* pool heat halo */
.spin-heat-0 .ring{box-shadow:0 0 20px rgba(0,234,255,.4);}
.spin-heat-1 .ring{box-shadow:0 0 26px rgba(0,234,255,.55);}
.spin-heat-2 .ring{box-shadow:0 0 34px rgba(255,179,71,.7);}
.spin-heat-3 .ring{box-shadow:0 0 46px rgba(255,75,106,.9);}

/* fee */
.fee{
  min-width:96px;border-radius:12px;border:1px solid var(--border);
  background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
  backdrop-filter:blur(10px);
  padding:6px 8px;display:flex;flex-direction:column;align-items:center;gap:4px;
  font-size:10px;
}
.fee-label{opacity:.7;font-size:9px;letter-spacing:.08em;text-transform:uppercase;}
.fee .val{
  min-width:80px;padding:4px 6px;border-radius:10px;text-align:center;
  font-weight:900;font-size:11px;
  border:1px solid rgba(0,234,255,.28);
  background:linear-gradient(135deg,rgba(0,234,255,.16),rgba(0,255,153,.18));
}
.fee .val span{margin-right:2px;}
.stepper{
  display:flex;gap:4px;margin-top:2px;align-items:center;justify-content:center;
}
.ix{
  width:24px;height:24px;border-radius:9px;
  border:1px solid var(--border);
  background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
  font-weight:900;font-size:14px;
}
.quick{
  width:32px;height:24px;border-radius:9px;
  border:1px solid rgba(0,234,255,.4);
  background:linear-gradient(135deg,rgba(0,234,255,.1),rgba(0,255,153,.1));
  font-weight:800;font-size:10px;
}

/* banner & toast */
.banner{
  position:fixed;left:50%;top:50%;
  transform:translate(-50%,-50%) scale(.7);
  background:rgba(3,5,15,.96);
  border:3px solid var(--green);
  padding:16px 28px;border-radius:18px;
  font-weight:900;letter-spacing:2px;opacity:0;
  box-shadow:0 0 80px var(--green),0 0 100px rgba(255,255,255,.4);
  backdrop-filter:blur(18px);z-index:5;font-size:18px;
}
.banner.show{animation:pop 2.3s ease-out forwards}
.toast{
  position:fixed;left:50%;bottom:16px;transform:translateX(-50%) translateY(40px);
  padding:8px 14px;border-radius:14px;
  background:rgba(10,14,30,.95);
  border:1px solid rgba(255,255,255,.12);
  font-size:11px;opacity:0;z-index:5;
}
.toast.show{animation:toastIn 1.6s ease-out forwards}

/* keyframes */
@keyframes pulseDot{
  0%,100%{transform:scale(1);opacity:1}
  50%{transform:scale(1.15);opacity:.7}
}
@keyframes float{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-14px)}
}
@keyframes wave{
  0%{transform:scale(.8);opacity:.85}
  100%{transform:scale(2.1);opacity:0}
}
@keyframes ring{to{transform:rotate(360deg)}}
@keyframes pop{
  0%{opacity:0;transform:translate(-50%,-50%) scale(.7)}
  20%{opacity:1;transform:translate(-50%,-50%) scale(1.06)}
  100%{opacity:0;transform:translate(-50%,-50%) scale(1)}
}
@keyframes toastIn{
  0%{opacity:0;transform:translateX(-50%) translateY(40px)}
  20%{opacity:1;transform:translateX(-50%) translateY(0)}
  100%{opacity:0;transform:translateX(-50%) translateY(40px)}
}

@media (max-width:360px){
  .spin{width:110px;height:110px}
  .pane{font-size:28px}
}
</style>
</head>
<body>
<canvas class="bg" id="sky"></canvas>
<canvas class="aur" id="aurora"></canvas>

<div class="app">
  <!-- HEADER -->
  <div class="header">
    <button class="back" id="btnBack" title="Geri">‚üµ</button>
    <div class="brand">
      <div class="brand-top">
        <span class="brand-dot"></span>
        <span>POOL SPIN</span>
      </div>
      <div class="brand-sub">AI ‚Ä¢ WEB5 POOL</div>
    </div>
    <button class="fx-toggle on" id="btnFx" title="3D FX">FX</button>
  </div>

  <!-- GAME STAGE -->
  <div class="stage" id="stage">
    <div class="board-wrap" id="board3d">
      <div class="board" id="board"></div>
    </div>
  </div>

  <!-- BOTTOM STATS + HISTORY -->
  <div class="bottom">
    <div class="bottom-row">
      <div class="stat-box">
        <div class="stat-label">BALANCE</div>
        <div class="balance-val">
          <span id="balance">100.00</span><span class="cur">$</span>
        </div>
      </div>
      <div class="stat-box">
        <div class="stat-label">LAST WIN</div>
        <div class="lastwin-val"><span id="lastWin">0.00</span> $</div>
      </div>
    </div>
    <div class="history">
      <span class="history-label">LAST 3</span>
      <div class="dot-row">
        <span class="dot" id="h1"></span>
        <span class="dot" id="h2"></span>
        <span class="dot" id="h3"></span>
      </div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <button class="auto-btn" id="auto">AUTO</button>

    <button class="spin spin-heat-0" id="spin">
      <div class="ring"></div><div class="ring inner"></div>
      <div class="core">
        <div class="wave"></div><div class="wave d"></div>
      </div>
      <div class="spinlabel" id="spinLabel">SPIN</div>
    </button>

    <div class="fee">
      <div class="fee-label">POOL FEE</div>
      <div class="val"><span id="bet">0.10</span>$</div>
      <div class="stepper">
        <button class="ix" id="minus">‚àí</button>
        <button class="ix" id="plus">Ôºã</button>
        <button class="quick" id="half">¬Ω</button>
        <button class="quick" id="double">x2</button>
      </div>
    </div>
  </div>

  <!-- BANNER & TOAST -->
  <div class="banner" id="banner">MEGA WIN</div>
  <div class="toast" id="toast">Bo≈ü ge√ßti. Sƒ±radaki tur daha sƒ±cak üî•</div>
</div>

<script>
/* Telegram guard */
const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : {
  ready:()=>{}, expand:()=>{}, setHeaderColor:()=>{}, setBackgroundColor:()=>{},
  showAlert:m=>alert(m),
  showPopup:(o,cb)=>{ if(confirm(`${o.title}\n\n${o.message}`)) cb && cb('ok'); },
  HapticFeedback:{ notificationOccurred:()=>{}, impactOccurred:()=>{} }
};
tg.ready(); tg.expand(); tg.setHeaderColor('#050712'); tg.setBackgroundColor('#050712');

/* background: stars + aurora + web5 network */
(function bg(){
  const sky=document.getElementById('sky'), aur=document.getElementById('aurora');
  if(!sky.getContext) return;
  const sctx=sky.getContext('2d'), actx=aur.getContext('2d');
  let DPR=Math.min(window.devicePixelRatio||1,2),W=0,H=0,t=0;

  function resize(){
    W=sky.width=aur.width=Math.floor(innerWidth*DPR);
    H=sky.height=aur.height=Math.floor(innerHeight*DPR);
  }
  resize(); addEventListener('resize', resize);

  const stars=Array.from({length:190},()=>({
    x:Math.random()*W,y:Math.random()*H,r:(Math.random()*1.4+0.4)*DPR
  }));
  const ribbons=Array.from({length:3},()=>({
    p:Math.random()*Math.PI*2,
    speed:.0025+Math.random()*.0015,
    hue:Math.random()<.5?[123,92,255]:[0,234,255]
  }));
  const nodes=Array.from({length:32},()=>({
    x:Math.random()*W,y:Math.random()*H*0.7,
    vx:(Math.random()-.5)*0.15,
    vy:(Math.random()-.5)*0.15
  }));

  (function loop(){
    t+=1;
    // stars
    sctx.clearRect(0,0,W,H);
    stars.forEach(st=>{
      sctx.globalAlpha = 0.55 + 0.45*Math.sin((t*0.01) + st.x*0.001);
      sctx.fillStyle='#c5e8ff';
      sctx.beginPath(); sctx.arc(st.x, st.y, st.r, 0, Math.PI*2); sctx.fill();
    });

    // aurora
    actx.clearRect(0,0,W,H);
    ribbons.forEach((rb,i)=>{
      rb.p += rb.speed;
      const yBase = H*(0.23 + i*0.2);
      const amp = H*0.06*(i+1);
      const grad = actx.createLinearGradient(0,yBase-amp, 0,yBase+amp);
      const col = `rgba(${rb.hue[0]},${rb.hue[1]},${rb.hue[2]},`;
      grad.addColorStop(0,   col+'0)');
      grad.addColorStop(.25, col+'0.18)');
      grad.addColorStop(.5,  col+'0.32)');
      grad.addColorStop(.75, col+'0.18)');
      grad.addColorStop(1,   col+'0)');
      actx.fillStyle=grad;

      actx.beginPath();
      actx.moveTo(0, yBase + Math.sin(rb.p)*amp);
      for(let x=0;x<=W;x+=30){
        const y = yBase + Math.sin(rb.p + x*0.002 + i)*amp;
        actx.lineTo(x, y);
      }
      actx.lineTo(W, yBase + amp*2);
      actx.lineTo(0, yBase + amp*2);
      actx.closePath();
      actx.fill();
    });

    // web5 nodes
    nodes.forEach(n=>{
      n.x+=n.vx; n.y+=n.vy;
      if(n.x<0||n.x>W) n.vx*=-1;
      if(n.y<0||n.y>H*0.8) n.vy*=-1;
    });
    actx.lineWidth=0.7*DPR;
    for(let i=0;i<nodes.length;i++){
      for(let j=i+1;j<nodes.length;j++){
        const dx=nodes[i].x-nodes[j].x, dy=nodes[i].y-nodes[j].y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<140*DPR){
          const alpha = 1 - dist/(140*DPR);
          actx.strokeStyle=`rgba(0,234,255,${0.15*alpha})`;
          actx.beginPath();
          actx.moveTo(nodes[i].x,nodes[i].y);
          actx.lineTo(nodes[j].x,nodes[j].y);
          actx.stroke();
        }
      }
    }
    nodes.forEach(n=>{
      actx.fillStyle='rgba(0,255,153,0.9)';
      actx.beginPath(); actx.arc(n.x,n.y,1.4*DPR,0,Math.PI*2); actx.fill();
    });

    requestAnimationFrame(loop);
  })();
})();

/* STATE */
let balance=100.00, bet=0.10, lastWin=0;
let spinning=false, auto=false;
let poolHeat=0;            // 0‚Äì3 arasƒ±, spin halo rengine etki
let fxOn=true;             // 3D tilt a√ßƒ±k mƒ±
const history=['none','none','none']; // last 3

const ROWS=5, COLS=6;
const SYMBOLS=['üçí','üçã','üçä','üçá','üíé','‚≠ê','üîî','7Ô∏è‚É£','üç¨','üí∞','üî•','‚ö°'];
const boardEl=document.getElementById('board');
const cells=[]; let board=[];

const $ = id => document.getElementById(id);
const fmt = x => (+x).toFixed(2);

function updateUI(){
  $('balance').textContent = fmt(balance);
  $('lastWin').textContent = fmt(lastWin);
  $('bet').textContent = fmt(bet);
  $('spinLabel').textContent = balance<bet ? 'NO FUNDS' : (auto ? 'AUTO' : 'SPIN');
  updateHistoryDots();
  updateHeatClass();
}

/* history dots */
function pushHistory(type){
  history.shift();
  history.push(type); // 'small', 'big', 'lose', 'none'
}
function updateHistoryDots(){
  ['h1','h2','h3'].forEach((id,i)=>{
    const el=$(id);
    el.className='dot';
    const t=history[i];
    if(t==='small') el.classList.add('win-small');
    else if(t==='big') el.classList.add('win-big');
    else if(t==='lose') el.classList.add('lose');
  });
}

/* pool heat vs halo */
function updateHeatClass(){
  poolHeat=Math.max(0,Math.min(3,poolHeat));
  const spin=$('spin');
  spin.classList.remove('spin-heat-0','spin-heat-1','spin-heat-2','spin-heat-3');
  spin.classList.add('spin-heat-'+poolHeat);
}

/* symbol & cell helpers */
function baseSymbol(){
  const base=['üçí','üçã','üçä','üçá','üç¨','‚≠ê','üîî','üî•','‚ö°','üí∞'];
  return base[Math.floor(Math.random()*base.length)];
}
function symbolPick(){
  // %8 rare (üíé,7Ô∏è‚É£), %92 base
  if(Math.random()<0.08){
    return Math.random()<0.5?'üíé':'7Ô∏è‚É£';
  }
  return baseSymbol();
}
function cellHTML(oldSym,newSym){
  let inner=`<div class="pane">${oldSym}</div>`;
  for(let i=0;i<12;i++){
    const s = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
    const rare = (s==='üíé'||s==='7Ô∏è‚É£') ? ' rare' : '';
    inner += `<div class="pane${rare}">${s}</div>`;
  }
  const rareNew=(newSym==='üíé'||newSym==='7Ô∏è‚É£')?' rare':'';
  inner += `<div class="pane${rareNew}">${newSym}</div>`;
  return `<div class="slot roll">${inner}</div>`;
}

/* build grid */
function build(){
  board = Array.from({length:ROWS}, ()=> Array.from({length:COLS}, ()=>symbolPick()));
  boardEl.innerHTML=''; cells.length=0;
  boardEl.style.gridTemplateRows=`repeat(${ROWS},1fr)`;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const d=document.createElement('div');
      d.className='cell';
      const s=board[r][c];
      const rare=(s==='üíé'||s==='7Ô∏è‚É£');
      d.innerHTML=`<div class="slot"><div class="pane${rare?' rare':''}">${s}</div></div>`;
      if(rare) d.classList.add('rare-orbit');
      boardEl.appendChild(d);
      cells.push(d);
    }
  }
}

/* controls */
$('minus').addEventListener('click',()=>{
  bet=Math.max(0.10, +(bet-0.10).toFixed(2));
  updateUI();
});
$('plus').addEventListener('click',()=>{
  bet=+(bet+0.10).toFixed(2);
  updateUI();
});
$('half').addEventListener('click',()=>{
  bet=Math.max(0.10, +(bet/2).toFixed(2));
  updateUI();
});
$('double').addEventListener('click',()=>{
  bet=+(bet*2).toFixed(2);
  updateUI();
});
$('auto').addEventListener('click',()=>{
  auto=!auto;
  $('auto').classList.toggle('on',auto);
  updateUI();
  if(auto && !spinning && balance>=bet) queue();
});
$('btnBack').addEventListener('click',()=> history.back());
$('btnFx').addEventListener('click',()=>{
  fxOn=!fxOn;
  $('btnFx').classList.toggle('on',fxOn);
  if(!fxOn){
    $('stage').style.transform='';
  }
});
$('spin').addEventListener('click',()=>{
  if(spinning) return;
  if(balance<bet){ tg.showAlert('Insufficient balance!'); return; }
  spin();
});

/* auto queue */
function queue(){
  if(!auto) return;
  if(balance<bet){ auto=false;$('auto').classList.remove('on');updateUI();return; }
  setTimeout(()=>{ if(auto) spin(); }, 650+Math.random()*320);
}

/* evaluation */
function evaluate(b,bet){
  const counts={};
  for(let r=0;r<ROWS;r++)
    for(let c=0;c<COLS;c++)
      counts[b[r][c]]=(counts[b[r][c]]||0)+1;

  let best=null,cnt=0;
  Object.entries(counts).forEach(([s,n])=>{ if(n>cnt){best=s;cnt=n;} });

  const mask=Array.from({length:ROWS},()=>Array.from({length:COLS},()=>false));
  let win=0;
  if(cnt>=8){
    const multi = (cnt>=12?15: cnt>=10?6: 2);
    win=+(bet*multi).toFixed(2);
    for(let r=0;r<ROWS;r++)
      for(let c=0;c<COLS;c++)
        if(b[r][c]===best) mask[r][c]=true;
  }
  return {win,mask,best};
}

/* win fx helpers */
function apply(mask,cls){
  let i=0;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(mask[r][c]) cells[i].classList.add(cls);
      i++;
    }
  }
}
function clearMask(mask,cls){
  let i=0;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(mask[r][c]) cells[i].classList.remove(cls);
      i++;
    }
  }
}
function flash(mask){
  return new Promise(res=>{
    apply(mask,'flash');
    setTimeout(()=>{
      apply(mask,'explode');
      setTimeout(()=>{
        clearMask(mask,'flash'); clearMask(mask,'explode');
        res();
      },350);
    },230);
  });
}
function cascade(mask){
  return new Promise(res=>{
    for(let c=0;c<COLS;c++){
      const keep=[];
      for(let r=ROWS-1;r>=0;r--) if(!mask[r][c]) keep.push(board[r][c]);
      while(keep.length<ROWS) keep.push(symbolPick());
      for(let r=ROWS-1;r>=0;r--) board[r][c]=keep[ROWS-1-r];
    }
    // repaint board after cascade
    for(let i=0;i<cells.length;i++){
      const r=Math.floor(i/COLS), c=i%COLS;
      const el=cells[i], sym=board[r][c];
      const top=el.querySelector('.pane:last-child')?.textContent || sym;
      const rare=(sym==='üíé'||sym==='7Ô∏è‚É£');
      el.classList.toggle('rare-orbit',rare);
      el.innerHTML=cellHTML(top,sym);
    }
    setTimeout(res,260);
  });
}

/* banner & toast */
function banner(txt){
  const b=$('banner');
  b.textContent=txt;
  b.classList.remove('show');
  void b.offsetWidth;
  b.classList.add('show');
}
function toast(txt){
  const t=$('toast');
  t.textContent=txt;
  t.classList.remove('show');
  void t.offsetWidth;
  t.classList.add('show');
}

/* spin flow */
function spin(){
  spinning=true;
  $('spin').disabled=true;
  document.querySelectorAll('.core .wave').forEach(e=> e.style.opacity='1');
  tg.HapticFeedback.impactOccurred('medium');

  gsap.to('#board3d',{rotationY:'+=360',duration:1.05,ease:'power2.inOut'});

  balance=+(balance-bet).toFixed(2);
  updateUI();

  // uzun slot animasyonu
  for(let i=0;i<cells.length;i++){
    const r=Math.floor(i/COLS), c=i%COLS;
    const oldSym=board[r][c];
    const newSym=symbolPick();
    board[r][c]=newSym;
    const el=cells[i];
    el.classList.toggle('rare-orbit',(newSym==='üíé'||newSym==='7Ô∏è‚É£'));
    el.innerHTML=cellHTML(oldSym,newSym);
  }

  const ROLL_MS=1250;
  setTimeout(()=>{
    const {win,mask,best}=evaluate(board,bet);
    lastWin=win;
    if(win>0){
      const ratio = win / bet;
      flash(mask).then(()=>cascade(mask).then(()=>onWin(win,ratio,best)));
    }else{
      onLose();
    }
  },ROLL_MS+60);
}

function onWin(amount,ratio,bestSym){
  try{
    const big = ratio>=10;
    confetti({
      particleCount: big?320:180,
      spread: big?120:90,
      origin:{y:.7}
    });
  }catch(_){}
  tg.HapticFeedback.notificationOccurred('success');
  balance=+(balance+amount).toFixed(2);

  const type = ratio>=10?'big':'small';
  pushHistory(type);
  poolHeat = Math.max(0, poolHeat-1); // havuz soƒüur
  updateHeatClass();

  if(ratio>=10){
    banner(`POOL HIT +${fmt(amount)} $`);
  }else{
    toast(`Kazan√ß +${fmt(amount)} $  ‚Ä¢  x${ratio.toFixed(1)}`);
  }

  if(bestSym==='üíé' || bestSym==='7Ô∏è‚É£'){
    toast(`RARE DROP ${bestSym} ‚Ä¢ Pool sana g√∂z kƒ±rptƒ± üí´`);
  }

  lastWin=amount;
  updateUI();
  spinning=false;
  $('spin').disabled=false;
  document.querySelectorAll('.core .wave').forEach(e=> e.style.opacity='');
  if(auto) queue();
}

function onLose(){
  tg.HapticFeedback.notificationOccurred('error');
  pushHistory('lose');
  poolHeat = Math.min(3,poolHeat+1); // √ºst √ºste kayƒ±pta havuz ƒ±sƒ±nsƒ±n
  updateHeatClass();
  toast(poolHeat>=2 ? 'Havuz ƒ±sƒ±nƒ±yor üî• Bir spin daha?' : 'Bo≈ü ge√ßti. Sƒ±radaki el senin!');

  updateUI();
  spinning=false;
  $('spin').disabled=false;
  document.querySelectorAll('.core .wave').forEach(e=> e.style.opacity='');
  if(auto) queue();
}

/* parallax tilt (FX toggle ile) */
(function(){
  const stage=$('stage');
  function apply(x,y){
    if(!fxOn){ stage.style.transform=''; return; }
    stage.style.transform=`rotateX(${y*5}deg) rotateY(${x*6}deg)`;
  }
  window.addEventListener('mousemove',e=>{
    if(!fxOn) return;
    const r=stage.getBoundingClientRect();
    const cx=(e.clientX-r.left)/r.width-.5;
    const cy=(e.clientY-r.top)/r.height-.5;
    apply(cx,cy);
  },{passive:true});
})();

/* INIT */
build();
updateUI();
</script>
</body>
</html>