<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>POOL SPIN ‚Ä¢ WEB5 3D</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<style>
  :root{
    --bg:#050712;
    --bg2:#050b1e;
    --bg3:#130824;
    --glass: rgba(255,255,255,0.04);
    --border: rgba(173,216,230,0.16);
    --cyan:#00eaff;
    --green:#00ff99;
    --violet:#a15cff;
    --pink:#ff46b9;
    --orange:#ffb347;
  }
  *{box-sizing:border-box}
  html,body{height:100%;overflow:hidden}
  body{
    margin:0; color:#eaf6ff;
    font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',Roboto,system-ui,sans-serif;
    background:
      radial-gradient(120% 160% at -10% -10%, #1b284b 0%, var(--bg) 55%),
      radial-gradient(80% 100% at 120% -10%, #23184b 0%, var(--bg2) 60%),
      radial-gradient(140% 180% at 50% 120%, #3a103f 0%, var(--bg3) 75%);
  }

  /* canvases */
  canvas.bg, canvas.aur{position:fixed; inset:0; pointer-events:none}
  canvas.bg{z-index:0; opacity:.6}
  canvas.aur{z-index:1; mix-blend-mode:screen; opacity:.55; filter:saturate(1.2)}

  .app{
    position:relative; z-index:2;
    height:100dvh; max-width:560px; margin:0 auto; padding:10px 12px 12px;
    display:flex; flex-direction:column; gap:8px;
  }

  /* HEADER */
  .header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .back{
    width:40px;height:40px;border-radius:14px;
    border:1px solid var(--border);
    background:linear-gradient(135deg,rgba(255,255,255,.05),rgba(255,255,255,.01));
    backdrop-filter:blur(14px);
    display:grid; place-items:center; font-size:18px;
  }
  .title-chip{
    flex:1;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.06);
    background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    backdrop-filter:blur(12px);
    font-size:11px;
    display:flex; align-items:center; gap:8px;
  }
  .pill-dot{
    width:9px;height:9px;border-radius:50%;
    background:conic-gradient(from 0deg,var(--cyan),var(--pink),var(--green),var(--cyan));
    box-shadow:0 0 12px rgba(0,234,255,.8);
    animation:pulseDot 2s ease-in-out infinite;
  }
  @keyframes pulseDot{
    0%,100%{transform:scale(1); opacity:1}
    50%{transform:scale(1.15); opacity:.7}
  }

  /* STAGE */
  .stage{
    flex:1; display:flex; align-items:center; justify-content:center;
    perspective:1100px; position:relative;
  }
  .board-wrap{
    width:min(94vw,360px); height:min(94vw,360px);
    transform-style:preserve-3d;
    animation:float 8s ease-in-out infinite;
  }
  @keyframes float{
    0%,100%{transform:translateY(0)}
    50%{transform:translateY(-14px)}
  }
  .board{
    position:relative; inset:0; height:100%;
    display:grid; grid-template-columns:repeat(6,1fr); gap:4px; padding:10px;
    border-radius:22px;
    background:radial-gradient(circle at 10% 0%,rgba(0,234,255,.3),transparent 48%),
               radial-gradient(circle at 90% 0%,rgba(255,70,185,.28),transparent 52%),
               linear-gradient(180deg, rgba(7,10,30,.9), rgba(5,7,22,.96));
    border:2px solid rgba(0,234,255,.22);
    box-shadow:
      0 0 50px rgba(0,234,255,.25),
      0 0 70px rgba(255,70,185,.18),
      inset 0 0 26px rgba(0,234,255,.2);
    backdrop-filter: blur(22px) saturate(1.25);
  }

  /* SYMBOL CELLS */
  .cell{
    position:relative; overflow:hidden;
    border-radius:14px;
    background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.18), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.16),
      0 10px 24px rgba(0,0,0,.55);
    backdrop-filter: blur(10px) saturate(1.1);
  }
  /* g√∂r√ºn√ºrl√ºƒü√º d√º≈ü√ºrmek i√ßin k√º√ß√ºk opaklƒ±k */
  .cell::before{
    content:'';
    position:absolute; inset:0;
    background:linear-gradient(145deg,rgba(5,10,30,.92),rgba(5,6,18,.94));
    opacity:.55;
  }

  .slot{
    position:absolute; inset:0;
    display:flex; flex-direction:column;
    transform:translateY(-1300%);
  }
  .pane{
    flex:0 0 100%;
    display:flex; align-items:center; justify-content:center;
    font-size:30px; line-height:1;
    position:relative; z-index:1;
    /* 3D symbol efekti */
    text-shadow:
      0 0 6px rgba(0,0,0,.7),
      0 0 10px rgba(0,234,255,.65),
      0 8px 12px rgba(0,0,0,.75);
    transform:translateZ(8px);
  }

  .roll{animation:roll 1.2s cubic-bezier(.18,.75,.25,1) forwards;}
  /* 14 pane -> ~13 adƒ±m; uzun slot hissi */
  @keyframes roll{
    from{transform:translateY(-1300%)}
    to{transform:translateY(0)}
  }

  /* win FX */
  .cell.flash::before{
    opacity:.1;
    background:radial-gradient(circle at 50% 10%,rgba(255,255,255,.9),rgba(0,255,153,.2) 40%,rgba(0,234,255,.05) 70%);
  }
  .cell.flash{
    box-shadow:
      0 0 40px rgba(0,255,153,.9),
      0 0 40px rgba(0,234,255,.8),
      0 0 70px rgba(255,255,255,.4);
  }
  .cell.explode{
    animation:explode .35s ease forwards;
  }
  @keyframes explode{
    to{
      transform:
        translateZ(32px)
        translateY(-12px)
        scale(.55)
        rotate3d(.4,.2,-.3,28deg);
      opacity:0;
      filter:blur(2px);
    }
  }

  /* BOTTOM BAR: balance + last win */
  .bottom-bar{
    display:flex; gap:10px; margin-top:2px;
  }
  .stat-box{
    flex:1;
    padding:8px 11px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.07);
    background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.015));
    backdrop-filter:blur(14px);
    font-size:11px;
  }
  .stat-label{
    opacity:.75; letter-spacing:.07em; font-size:9px; margin-bottom:2px;
  }
  .balance-val{
    display:flex; align-items:baseline; gap:4px;
    font-weight:900; font-size:13px;
    background:linear-gradient(90deg,var(--cyan),var(--green));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .balance-val span.cur{
    font-size:10px; -webkit-text-fill-color:#eaf6ff; color:#eaf6ff;
  }
  .lastwin-val{
    font-weight:800; font-size:13px; color:var(--orange);
    text-shadow:0 0 12px rgba(255,179,71,.6);
  }

  /* CONTROLS */
  .controls{
    display:flex; align-items:center; justify-content:center;
    gap:16px; padding:6px 0 0;
  }

  .auto-btn{
    width:38px;height:38px;
    border-radius:12px;
    border:1px solid var(--border);
    background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
    backdrop-filter:blur(10px);
    font-weight:900; font-size:9px; letter-spacing:.08em;
  }
  .auto-btn.on{
    background:rgba(0,255,153,.25);
    border-color:var(--green);
    box-shadow:0 0 16px rgba(0,255,153,.45) inset;
  }

  .spin{
    width:118px;height:118px;
    border-radius:50%; border:none; position:relative; cursor:pointer;
    background:radial-gradient(circle at 30% 30%, #00eaff, #0050ff);
    box-shadow:
      0 0 70px rgba(0,234,255,.55),
      0 0 90px rgba(255,70,185,.4),
      inset 0 0 30px rgba(255,255,255,.12);
  }
  .spin:disabled{opacity:.55; cursor:not-allowed}
  .ring{
    position:absolute; inset:-4px; border-radius:50%;
    background:conic-gradient(from 0deg,var(--cyan),var(--violet),var(--green),var(--pink),var(--cyan));
    animation:ring 4s linear infinite; filter:saturate(1.2);
  }
  .ring.inner{
    inset:10px;
    animation-duration:6s;
    opacity:.7;
    filter:blur(.2px);
  }
  @keyframes ring{to{transform:rotate(360deg)}}
  .spin .core{
    position:absolute; inset:14px; border-radius:50%;
    background:radial-gradient(120% 120% at 30% 30%, #1ad7ff, #004bff 70%);
    display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  .wave{
    position:absolute; inset:-18px;
    border-radius:50%; border:3px solid var(--cyan);
    opacity:0; animation:wave 2s ease-out infinite;
  }
  .wave.d{animation-delay:.5s}
  @keyframes wave{
    0%{transform:scale(.8); opacity:.85}
    100%{transform:scale(2.1); opacity:0}
  }
  .spinlabel{
    position:absolute; bottom:-24px; width:100%;
    text-align:center; font-weight:900; letter-spacing:2px;
    color:var(--cyan); text-shadow:0 0 16px var(--cyan); font-size:12px;
  }

  .fee{
    min-width:86px;
    border-radius:12px; border:1px solid var(--border);
    background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
    backdrop-filter:blur(10px);
    padding:6px 8px;
    display:flex; flex-direction:column; align-items:center; gap:4px;
    font-size:10px;
  }
  .fee-label{
    opacity:.7; font-size:9px; letter-spacing:.08em;
  }
  .fee .val{
    min-width:70px;
    padding:4px 6px;
    border-radius:10px;
    text-align:center;
    font-weight:900; font-size:11px;
    border:1px solid rgba(0,234,255,.28);
    background:linear-gradient(135deg, rgba(0,234,255,.16), rgba(0,255,153,.18));
  }
  .fee .val span{margin-right:2px;}
  .stepper{
    display:flex; gap:6px; margin-top:2px;
  }
  .ix{
    width:26px;height:26px;
    border-radius:9px;
    border:1px solid var(--border);
    background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
    font-weight:900; font-size:15px;
  }

  /* BANNER */
  .banner{
    position:fixed; left:50%; top:50%;
    transform:translate(-50%,-50%) scale(.7);
    background:rgba(3,5,15,.96);
    border:3px solid var(--green);
    padding:16px 28px;
    border-radius:18px;
    font-weight:900; letter-spacing:2px; opacity:0;
    box-shadow:
      0 0 80px var(--green),
      0 0 100px rgba(255,255,255,.4);
    backdrop-filter:blur(18px); z-index:5;
    font-size:18px;
  }
  .banner.show{animation:pop 2.3s ease-out forwards}
  @keyframes pop{
    0%{opacity:0; transform:translate(-50%,-50%) scale(.7)}
    20%{opacity:1; transform:translate(-50%,-50%) scale(1.06)}
    100%{opacity:0; transform:translate(-50%,-50%) scale(1)}
  }

  @media (max-width:360px){
    .spin{width:110px;height:110px}
    .pane{font-size:28px}
  }
</style>
</head>
<body>
  <canvas class="bg" id="sky"></canvas>
  <canvas class="aur" id="aurora"></canvas>

  <div class="app">
    <!-- HEADER -->
    <div class="header">
      <button class="back" id="btnBack" title="Geri">‚üµ</button>
      <div class="title-chip">
        <span class="pill-dot"></span>
        <span>POOL SPIN ‚Ä¢ WEB5 AI NETWORK</span>
      </div>
    </div>

    <!-- GAME STAGE -->
    <div class="stage" id="stage">
      <div class="board-wrap" id="board3d">
        <div class="board" id="board"></div>
      </div>
    </div>

    <!-- BALANCE + LAST WIN -->
    <div class="bottom-bar">
      <div class="stat-box">
        <div class="stat-label">BALANCE</div>
        <div class="balance-val">
          <span id="balance">100.00</span>
          <span class="cur">$</span>
        </div>
      </div>
      <div class="stat-box">
        <div class="stat-label">LAST WIN</div>
        <div class="lastwin-val"><span id="lastWin">0.00</span> $</div>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
      <button class="auto-btn" id="auto">AUTO</button>

      <button class="spin" id="spin">
        <div class="ring"></div><div class="ring inner"></div>
        <div class="core"><div class="wave"></div><div class="wave d"></div></div>
        <div class="spinlabel">SPIN</div>
      </button>

      <div class="fee">
        <div class="fee-label">POOL FEE</div>
        <div class="val"><span id="bet">0.10</span>$</div>
        <div class="stepper">
          <button class="ix" id="minus">‚àí</button>
          <button class="ix" id="plus">Ôºã</button>
        </div>
      </div>
    </div>

    <!-- BANNER -->
    <div class="banner" id="banner">READY</div>
  </div>

<script>
/* Telegram guard */
const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : {
  ready:()=>{}, expand:()=>{}, setHeaderColor:()=>{}, setBackgroundColor:()=>{},
  showAlert: m=>alert(m),
  showPopup:(o,cb)=>{ if(confirm(`${o.title}\n\n${o.message}`)) cb && cb('ok'); },
  HapticFeedback:{ notificationOccurred:()=>{}, impactOccurred:()=>{} }
};
tg.ready(); tg.expand(); tg.setHeaderColor('#050712'); tg.setBackgroundColor('#050712');

/* background: stars + aurora + web5 network */
(function bg(){
  const sky=document.getElementById('sky'), aur=document.getElementById('aurora');
  const sctx=sky.getContext('2d'), actx=aur.getContext('2d');
  let DPR=Math.min(devicePixelRatio||1,2),W=0,H=0,t=0;

  function resize(){
    W=sky.width=aur.width=Math.floor(innerWidth*DPR);
    H=sky.height=aur.height=Math.floor(innerHeight*DPR);
  }
  resize(); addEventListener('resize', resize);

  const stars=Array.from({length:190},()=>({
    x:Math.random()*W,y:Math.random()*H,r:(Math.random()*1.4+0.4)*DPR
  }));
  const ribbons=Array.from({length:3},()=>({
    p:Math.random()*Math.PI*2,
    speed:.0025+Math.random()*.0015,
    hue: Math.random()<.5? [123,92,255] : [0,234,255]
  }));
  const nodes=Array.from({length:32},()=>({
    x:Math.random()*W,y:Math.random()*H*0.7,
    vx:(Math.random()-.5)*0.15,
    vy:(Math.random()-.5)*0.15
  }));

  (function loop(){
    t+=1;
    // stars
    sctx.clearRect(0,0,W,H);
    stars.forEach(st=>{
      sctx.globalAlpha = 0.55 + 0.45*Math.sin((t*0.01) + st.x*0.001);
      sctx.fillStyle='#c5e8ff';
      sctx.beginPath(); sctx.arc(st.x, st.y, st.r, 0, Math.PI*2); sctx.fill();
    });

    // aurora + network
    actx.clearRect(0,0,W,H);
    ribbons.forEach((rb,i)=>{
      rb.p += rb.speed;
      const yBase = H*(0.23 + i*0.2);
      const amp = H*0.06*(i+1);
      const grad = actx.createLinearGradient(0,yBase-amp, 0,yBase+amp);
      const col = `rgba(${rb.hue[0]},${rb.hue[1]},${rb.hue[2]},`;
      grad.addColorStop(0,   col+'0)');
      grad.addColorStop(.25, col+'0.18)');
      grad.addColorStop(.5,  col+'0.32)');
      grad.addColorStop(.75, col+'0.18)');
      grad.addColorStop(1,   col+'0)');
      actx.fillStyle=grad;

      actx.beginPath();
      actx.moveTo(0, yBase + Math.sin(rb.p)*amp);
      for(let x=0;x<=W;x+=30){
        const y = yBase + Math.sin(rb.p + x*0.002 + i)*amp;
        actx.lineTo(x, y);
      }
      actx.lineTo(W, yBase + amp*2);
      actx.lineTo(0, yBase + amp*2);
      actx.closePath();
      actx.fill();
    });

    // web5 network nodes + links
    nodes.forEach(n=>{
      n.x+=n.vx; n.y+=n.vy;
      if(n.x<0||n.x>W) n.vx*=-1;
      if(n.y<0||n.y>H*0.8) n.vy*=-1;
    });
    actx.lineWidth=0.7*DPR;
    for(let i=0;i<nodes.length;i++){
      for(let j=i+1;j<nodes.length;j++){
        const dx=nodes[i].x-nodes[j].x, dy=nodes[i].y-nodes[j].y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<140*DPR){
          const alpha = 1 - dist/(140*DPR);
          actx.strokeStyle=`rgba(0,234,255,${0.15*alpha})`;
          actx.beginPath();
          actx.moveTo(nodes[i].x,nodes[i].y);
          actx.lineTo(nodes[j].x,nodes[j].y);
          actx.stroke();
        }
      }
    }
    nodes.forEach(n=>{
      actx.fillStyle='rgba(0,255,153,0.9)';
      actx.beginPath(); actx.arc(n.x,n.y,1.4*DPR,0,Math.PI*2); actx.fill();
    });

    requestAnimationFrame(loop);
  })();
})();

/* STATE */
let balance=100.00, bet=0.10, lastWin=0;
let spinning=false, auto=false;

const ROWS=5, COLS=6;
const SYMBOLS=['üçí','üçã','üçä','üçá','üíé','‚≠ê','üîî','7Ô∏è‚É£','üç¨','üí∞','üî•','‚ö°'];
const boardEl=document.getElementById('board');
const cells=[]; let board=[];

const $ = id => document.getElementById(id);
const fmt = x => (+x).toFixed(2);

function updateUI(){
  $('balance').textContent = fmt(balance);
  $('lastWin').textContent = fmt(lastWin);
  $('bet').textContent = fmt(bet);
}

/* SYMBOL & CELL HELPERS */
function symbolPick(){
  const pool=['üçí','üçã','üçä','üçá','üç¨','‚≠ê','üîî','üî•','‚ö°','üí∞','7Ô∏è‚É£','üíé'];
  return pool[Math.random()<0.08?11:(Math.random()<0.12?10:Math.floor(Math.random()*10))];
}
function cellHTML(oldSym, newSym){
  // web5 tarzƒ± uzun animasyon i√ßin: old + 12 random + new
  let inner = `<div class="pane">${oldSym}</div>`;
  for(let i=0;i<12;i++){
    inner += `<div class="pane">${SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]}</div>`;
  }
  inner += `<div class="pane">${newSym}</div>`;
  return `<div class="slot roll">${inner}</div>`;
}

/* BUILD GRID */
function build(){
  board = Array.from({length:ROWS}, ()=> Array.from({length:COLS}, ()=>symbolPick()));
  boardEl.innerHTML=''; cells.length=0;
  boardEl.style.gridTemplateRows = `repeat(${ROWS}, 1fr)`;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const d=document.createElement('div');
      d.className='cell';
      const s = board[r][c];
      d.innerHTML = `<div class="slot"><div class="pane">${s}</div></div>`;
      boardEl.appendChild(d);
      cells.push(d);
    }
  }
}

/* CONTROLS */
$('minus').addEventListener('click', ()=>{
  bet = Math.max(0.10, +(bet - 0.10).toFixed(2));
  updateUI();
});
$('plus').addEventListener('click', ()=>{
  bet = +(bet + 0.10).toFixed(2);
  updateUI();
});
$('auto').addEventListener('click', ()=>{
  auto=!auto;
  $('auto').classList.toggle('on', auto);
  if(auto && !spinning && balance>=bet) queue();
});
$('btnBack').addEventListener('click', ()=> history.back());
$('spin').addEventListener('click', ()=>{
  if(spinning) return;
  if(balance < bet) return tg.showAlert('Insufficient balance!');
  spin();
});

function queue(){
  if(!auto) return;
  if(balance<bet){ auto=false; $('auto').classList.remove('on'); return; }
  setTimeout(()=>{ if(auto) spin(); }, 650 + Math.random()*320);
}

/* EVALUATION */
function evaluate(b, bet){
  const counts={};
  for(let r=0;r<ROWS;r++)
    for(let c=0;c<COLS;c++)
      counts[b[r][c]]=(counts[b[r][c]]||0)+1;

  let best=null, cnt=0;
  Object.entries(counts).forEach(([s,n])=>{
    if(n>cnt){ best=s; cnt=n; }
  });

  const mask=Array.from({length:ROWS},()=>Array.from({length:COLS},()=>false));
  let win=0;
  if(cnt>=8){
    const multi = (cnt>=12?15: cnt>=10?6: 2);
    win = +(bet*multi).toFixed(2);
    for(let r=0;r<ROWS;r++)
      for(let c=0;c<COLS;c++)
        if(b[r][c]===best) mask[r][c]=true;
  }
  return {win, mask};
}

/* WIN FX HELPERS */
function apply(mask, cls){
  let i=0;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(mask[r][c]) cells[i].classList.add(cls);
      i++;
    }
  }
}
function clear(mask, cls){
  let i=0;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(mask[r][c]) cells[i].classList.remove(cls);
      i++;
    }
  }
}
function flash(mask){
  return new Promise(res=>{
    apply(mask,'flash');
    setTimeout(()=>{
      apply(mask,'explode');
      setTimeout(()=>{
        clear(mask,'flash'); clear(mask,'explode');
        res();
      }, 350);
    }, 230);
  });
}
function cascade(mask){
  return new Promise(res=>{
    for(let c=0;c<COLS;c++){
      const keep=[];
      for(let r=ROWS-1;r>=0;r--) if(!mask[r][c]) keep.push(board[r][c]);
      while(keep.length<ROWS) keep.push(symbolPick());
      for(let r=ROWS-1;r>=0;r--) board[r][c]=keep[ROWS-1-r];
    }
    // yeni tabloyu tekrar web5 slot animasyonu ile boya
    for(let i=0;i<cells.length;i++){
      const r = Math.floor(i/COLS), c = i%COLS;
      const el=cells[i], symNow = board[r][c];
      const top = el.querySelector('.pane:last-child')?.textContent || symNow;
      el.innerHTML = cellHTML(top, symNow);
    }
    setTimeout(res, 260);
  });
}

/* BANNER */
function banner(txt){
  const b=$('banner');
  b.textContent=txt;
  b.classList.remove('show');
  void b.offsetWidth;
  b.classList.add('show');
}

/* SPIN FLOW */
function spin(){
  spinning=true;
  $('spin').disabled=true;
  document.querySelectorAll('.ring,.core .wave').forEach(e=> e.style.opacity='1');
  tg.HapticFeedback.impactOccurred('medium');

  gsap.to('#board3d',{ rotationY:'+=360', duration:1.05, ease:'power2.inOut' });

  balance = +(balance - bet).toFixed(2);
  updateUI();

  // uzun slot animasyonu
  for(let i=0;i<cells.length;i++){
    const r = Math.floor(i/COLS), c = i%COLS;
    const oldSym = board[r][c];
    const newSym = symbolPick();
    board[r][c] = newSym;
    const el=cells[i];
    el.innerHTML = cellHTML(oldSym, newSym);
  }

  const ROLL_MS = 1200;
  setTimeout(()=>{
    const {win, mask} = evaluate(board, bet);
    lastWin=win;
    if(win>0){
      flash(mask).then(()=> cascade(mask).then(()=> onWin(win)));
    }else{
      onLose();
    }
  }, ROLL_MS + 50);
}

function onWin(amount){
  try{
    confetti({ particleCount: 260, spread: 110, origin:{y:.7} });
  }catch(_){}
  tg.HapticFeedback.notificationOccurred('success');
  balance = +(balance + amount).toFixed(2);
  banner(`MEGA WIN +${fmt(amount)} $`);
  updateUI();
  spinning=false;
  $('spin').disabled=false;
  document.querySelectorAll('.ring,.core .wave').forEach(e=> e.style.opacity='');
  if(auto) queue();
}
function onLose(){
  tg.HapticFeedback.notificationOccurred('error');
  banner('TRY AGAIN!');
  updateUI();
  spinning=false;
  $('spin').disabled=false;
  document.querySelectorAll('.ring,.core .wave').forEach(e=> e.style.opacity='');
  if(auto) queue();
}

/* parallax tilt */
(function(){
  const stage = document.getElementById('stage');
  function apply(x,y){
    stage.style.transform=`rotateX(${y*5}deg) rotateY(${x*6}deg)`;
  }
  window.addEventListener('mousemove', e=>{
    const r=stage.getBoundingClientRect();
    const cx=(e.clientX-r.left)/r.width-.5;
    const cy=(e.clientY-r.top)/r.height-.5;
    apply(cx,cy);
  }, {passive:true});
})();

/* INIT */
build();
updateUI();
addEventListener('resize', ()=> build());
</script>
</body>
</html>