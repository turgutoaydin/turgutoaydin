<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Kule Oyunu - Ekran</title>
<style>
  body { margin:0; background:#111; color:white; font-family:Arial; text-align:center; }
  canvas { background:#000; display:block; margin:20px auto; border:2px solid #444; }
  #info { font-size:28px; margin:20px; }
  #qr { width:250px; height:250px; margin:30px auto; background:white; padding:10px; border-radius:10px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
<h1>Kule Oyunu - Büyük Ekran</h1>
<div id="info">Şifre: <span id="password">-</span> | Skor: <span id="score">0</span></div>
<canvas id="canvas" width="400" height="600"></canvas>
<div id="qr"></div>
<p>Telefonla QR'ı tara veya şifreyi gir → Kumanda aktif olsun!</p>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

// Rastgele 4 haneli şifre
const password = Math.floor(1000 + Math.random() * 9000);
document.getElementById('password').textContent = password;

// Controller URL'si (şifre ile)
const controllerUrl = `https://turgutoaydin.github.io/pokemonw3/?pass=${password}`;
QRCode.toCanvas(document.getElementById('qr'), controllerUrl, {width:250});

// Oyun değişkenleri
let blocks = [{x:100, y:H-50, w:200, h:50}]; // taban
let currentBlock = null;
let direction = 1;
let speed = 3;
let score = 0;
let gameOver = false;

// URL'den drop komutu kontrol et (her saniye)
setInterval(() => {
  const params = new URLSearchParams(location.search);
  if(params.get('drop') === '1' && currentBlock) {
    dropBlock();
    // URL'yi temizle (isteğe bağlı)
    history.replaceState(null, '', location.pathname);
  }
}, 500);

function newCurrentBlock() {
  if(gameOver) return;
  currentBlock = {x:0, y:100, w:blocks[blocks.length-1].w, h:50};
  direction = Math.random() > 0.5 ? 1 : -1;
  speed += 0.4;
}

function dropBlock() {
  if(gameOver || !currentBlock) return;
  
  const last = blocks[blocks.length-1];
  let newX = currentBlock.x;
  let newW = currentBlock.w;

  // Taşma kontrolü (basit versiyon)
  if(currentBlock.x < last.x) {
    newW = currentBlock.x + currentBlock.w - last.x;
    newX = last.x;
  } else if(currentBlock.x + currentBlock.w > last.x + last.w) {
    newW = last.x + last.w - currentBlock.x;
  }

  if(newW <= 20) {
    gameOver = true;
    alert('Oyun Bitti! Skor: ' + score);
    return;
  }

  blocks.push({x:newX, y:last.y - 50, w:newW, h:50});
  score++;
  document.getElementById('score').textContent = score;
  newCurrentBlock();
}

function draw() {
  ctx.clearRect(0,0,W,H);
  
  // Kule
  blocks.forEach(b => {
    ctx.fillStyle = '#4CAF50';
    ctx.fillRect(b.x, b.y, b.w, b.h);
  });
  
  // Sallanan küp
  if(currentBlock) {
    ctx.fillStyle = '#FF9800';
    ctx.fillRect(currentBlock.x, currentBlock.y, currentBlock.w, currentBlock.h);
  }
  
  if(gameOver) {
    ctx.font = '40px Arial';
    ctx.fillStyle = 'red';
    ctx.fillText('OYUN BİTTİ', W/2 - 120, H/2);
  }
}

function update() {
  if(gameOver || !currentBlock) return;
  currentBlock.x += speed * direction;
  if(currentBlock.x <= 0 || currentBlock.x + currentBlock.w >= W) {
    direction *= -1;
  }
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

newCurrentBlock();
loop();
</script>
</body>
</html>
